{% extends 'layout.html' %}

{% block content %}
<div style="width:100%;height:320px;background-image: url({{ url_for('static', filename='images/banner_bg_blue.png') }});background-size: cover;">
  <div style="width:100%;height:320px;background-image: url({{ url_for('static', filename='images/main.svg') }});background-size: contain;background-position: bottom left;background-repeat: no-repeat;"></div>
</div>

<div class="body_content">

  <sl-card class="card-basic" style="width: 100%;">
    <sl-tab-group  placement="start">
      <sl-tab slot="nav" panel="step1" class="step1"><sl-icon-button name="1-square"></sl-icon-button>  Task to Achive</sl-tab>
      <sl-tab slot="nav" panel="step2" class="step2"><sl-icon-button name="2-square"></sl-icon-button>  Project Generation</sl-tab>
      <sl-tab slot="nav" panel="step3" class="step3"><sl-icon-button name="3-square"></sl-icon-button>  Project Output</sl-tab>
    
      <sl-tab-panel name="step1">
        <form action="{{ url_for('submit_form') }}" method="post" id="projectForm">
        <div class="form-group">
          <label for="project_name">Project Name:</label>
          <input type="text" class="form-control" id="project_name" name="project_name" placeholder="Enter project name" required>
        </div>

        <div class="form-group">
          <label for="user_input">Description:</label>
          <textarea class="form-control" id="user_input" name="user_input" placeholder="Enter some text" rows="5" required></textarea>
        </div>
        
        <sl-button type="submit" variant="primary" onclick="nextTab(2)" style="--sl-color-primary-600:#0032F5;">Generate Project</sl-button>
        </form>
      </sl-tab-panel>
      <sl-tab-panel name="step2">
        <h3 class="card-title">Message Log</h3>
          
            <!-- <h2>Live Logs</h2> -->
            <!-- Move the Kill Process button below the h2 and float it to the right -->
            <button onclick="killProcess()" style="float: right; margin-bottom: 10px;">Kill Process</button>
            
            <!-- Clear the float -->
            <div style="clear: both;"></div>
    
            <!-- Container for the log with a scrollbar -->
            <div id="logContainer" style="max-height: 750px; overflow-y: auto; border: 1px solid gray;">
                <pre id="log"></pre>
                </div>
                
              
      </sl-tab-panel>
      <sl-tab-panel name="step3">
        <h3 class="card-title">Tool Output</h3>
          <p>You can download the project code from below ...</p>
          <table class="table">
            <thead>
              <tr>
                <th>File Name</th>
                <th>Download</th>
              </tr>
            </thead>
            <tbody>
              {% for file in files %}
              <tr>
                <td>{{ file }}</td>
                <td><a href="{{ url_for('download_file', filename=file) }}" class="btn btn-success" style="background-color:#0032F5;border-color:#0032F5">Download</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
      </sl-tab-panel>
    </sl-tab-group>
  </sl-card>
</div>



<script>
   function nextTab(tabNum) {
    document.querySelector('sl-tab-group').show('step'+tabNum)
  }
  function killProcess() {
      fetch('/kill')
        .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
        })
        .catch(error => {
          console.log('There was a problem with the fetch operation:', error.message);
        });
  }

  if (!!window.EventSource) {
      var source = new EventSource('/logstream');

      source.onmessage = function(event) {
          var logElement = document.getElementById("log");
          var container = document.getElementById("logContainer");
          
          logElement.textContent += event.data + "\n";

          // Scroll to the bottom
          container.scrollTop = container.scrollHeight;
      };

      source.onerror = function(event) {
          console.error("EventSource failed:", event);
          source.close();
      };
  } else {
      console.log("Your browser doesn't support SSE");
  }
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('projectForm');

    form.addEventListener('submit', function(event) {
        // Check if the form is valid. If not, return and don't switch tabs.
        if (!form.checkValidity()) {
            return;
        }
        
        // Prevent the default form submission for a moment.
        event.preventDefault();
        
        // Move to the next tab.
        nextTab(2);
        
        // Submit the form after a short delay, giving the tab switch animation some time.
        setTimeout(function() {
            form.submit();
        }, 100);  // 100ms delay. Adjust as needed.
    });
});

</script>

{% endblock %}
